/**
 * Main Game Initialization
 *
 * Initialisiert das Spiel und verbindet die Game-Logic mit dem UI
 */

// Erstelle neue Game-Instanz
const game = new IdleGame({
    tickRate: 100,        // Update alle 100ms
    saveInterval: 5000,   // Auto-Save alle 5 Sekunden
    saveKey: 'idleClickerSave'
});

// ===== UI ELEMENTE =====
const pointsDisplay = document.getElementById('points');
const pointsPerSecondDisplay = document.getElementById('pointsPerSecond');
const clickButton = document.getElementById('clickButton');
const clickValueDisplay = document.getElementById('clickValue');
const upgradesContainer = document.getElementById('upgradesContainer');

// ===== UPGRADE DEFINITIONEN =====
// Basis-Upgrades (immer verf√ºgbar)

const upgradeDefinitions = [
    {
        id: 'clickPower',
        name: 'Click Power',
        description: 'Erh√∂ht die Punkte pro Click',
        baseCost: 10,
        costMultiplier: 1.5,
        effect: (state, level) => {
            // Jedes Level f√ºgt +1 Click Power hinzu
            state.clickPower += level;
        }
    },
    {
        id: 'autoClicker',
        name: 'Auto Clicker',
        description: 'Generiert automatisch Punkte pro Sekunde',
        baseCost: 25,
        costMultiplier: 1.3,
        effect: (state, level) => {
            // Jedes Level f√ºgt +0.5 Punkte pro Sekunde hinzu
            state.pointsPerSecond += level * 0.5;
        }
    },
    {
        id: 'pointsMultiplier',
        name: 'Points Multiplier',
        description: 'Multipliziert alle Punktegewinne',
        baseCost: 100,
        costMultiplier: 2.0,
        effect: (state, level) => {
            // Jedes Level erh√∂ht Click Power und PPS um 10%
            const multiplier = 1 + (level * 0.1);
            state.clickPower = Math.floor(state.clickPower * multiplier);
            state.pointsPerSecond = state.pointsPerSecond * multiplier;
        }
    },
    // ===== LOCKED UPGRADES =====
    // Diese Upgrades m√ºssen erst freigeschaltet werden
    {
        id: 'superClicker',
        name: 'Super Clicker',
        description: 'Massiv erh√∂hte Click Power (+5 pro Level)',
        baseCost: 500,
        costMultiplier: 1.8,
        effect: (state, level) => {
            state.clickPower += level * 5;
        },
        unlockCondition: (game) => {
            // Unlock: Erreiche 1000 Punkte
            return game.state.totalPointsEarned >= 1000;
        },
        unlockDescription: 'Erreiche 1000 Punkte insgesamt'
    },
    {
        id: 'clickMaster',
        name: 'Click Master',
        description: 'Meisterhafte Klick-F√§higkeiten (Click Power x1.5)',
        baseCost: 2000,
        costMultiplier: 2.5,
        effect: (state, level) => {
            const multiplier = 1 + (level * 0.5);
            state.clickPower = Math.floor(state.clickPower * multiplier);
        },
        unlockCondition: (game) => {
            // Unlock: Klicke 100 mal
            return game.state.totalClicks >= 100;
        },
        unlockDescription: 'Klicke 100 mal'
    },
    {
        id: 'autoFactory',
        name: 'Auto Factory',
        description: 'Produziert automatisch 5 Punkte/Sekunde',
        baseCost: 1500,
        costMultiplier: 1.6,
        effect: (state, level) => {
            state.pointsPerSecond += level * 5;
        },
        unlockCondition: (game) => {
            // Unlock: Kaufe Auto Clicker 10x
            return game.getUpgradeLevel('autoClicker') >= 10;
        },
        unlockDescription: 'Kaufe Auto Clicker 10x'
    },
    {
        id: 'megaMultiplier',
        name: 'Mega Multiplier',
        description: 'Verdoppelt alle Punktegewinne',
        baseCost: 5000,
        costMultiplier: 3.0,
        effect: (state, level) => {
            const multiplier = Math.pow(2, level); // 2x, 4x, 8x, etc.
            state.clickPower = Math.floor(state.clickPower * multiplier);
            state.pointsPerSecond = state.pointsPerSecond * multiplier;
        },
        unlockCondition: (game) => {
            // Unlock: Kaufe Points Multiplier 5x
            return game.getUpgradeLevel('pointsMultiplier') >= 5;
        },
        unlockDescription: 'Kaufe Points Multiplier 5x'
    },
    {
        id: 'idleMaster',
        name: 'Idle Master',
        description: 'Drastisch erh√∂hte passive Produktion (+20/s)',
        baseCost: 10000,
        costMultiplier: 2.2,
        effect: (state, level) => {
            state.pointsPerSecond += level * 20;
        },
        unlockCondition: (game) => {
            // Unlock: Erreiche 5 Punkte pro Sekunde
            return game.state.pointsPerSecond >= 5;
        },
        unlockDescription: 'Erreiche 5 Punkte pro Sekunde'
    }
];

// ===== UPGRADE UI ERSTELLEN =====
/**
 * Erstellt eine Upgrade-Karte im UI
 * @param {Upgrade} upgrade - Das Upgrade-Objekt
 * @returns {HTMLElement} Das erstellte DOM-Element
 */
function createUpgradeCard(upgrade) {
    const card = document.createElement('div');
    card.className = 'upgrade-card';
    card.id = `upgrade-${upgrade.id}`;

    card.innerHTML = `
        <div class="upgrade-header">
            <span class="upgrade-name">${upgrade.name}</span>
            <span class="upgrade-level">Lvl <span id="level-${upgrade.id}">0</span></span>
        </div>
        <p class="upgrade-description">${upgrade.description}</p>
        <div class="unlock-requirement" id="unlock-${upgrade.id}" style="display: none;">
            <span class="lock-icon">üîí</span>
            <span class="unlock-text"></span>
        </div>
        <div class="upgrade-stats" id="stats-${upgrade.id}">
            <div class="upgrade-stat">
                <span>Cost:</span>
                <span id="cost-${upgrade.id}">0</span>
            </div>
            <div class="upgrade-stat">
                <span>Next Cost:</span>
                <span id="nextCost-${upgrade.id}">0</span>
            </div>
        </div>
        <button class="upgrade-button" id="btn-${upgrade.id}">
            BUY
        </button>
    `;

    return card;
}

// ===== UPGRADES REGISTRIEREN =====
upgradeDefinitions.forEach(def => {
    const upgrade = game.registerUpgrade(def);
    const card = createUpgradeCard(upgrade);
    upgradesContainer.appendChild(card);
});

// Lade gespeicherte Upgrade-Levels
game.loadUpgradeLevels();

// ===== UI UPDATE FUNKTIONEN =====

/**
 * Formatiert Zahlen f√ºr die Anzeige
 * @param {number} num - Die zu formatierende Zahl
 * @returns {string} Formatierte Zahl
 */
function formatNumber(num) {
    if (num >= 1000000) {
        return (num / 1000000).toFixed(2) + 'M';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(2) + 'K';
    }
    return Math.floor(num).toString();
}

/**
 * Aktualisiert die Punkte-Anzeige
 */
function updatePointsDisplay() {
    pointsDisplay.textContent = formatNumber(game.state.points);
}

/**
 * Aktualisiert die Points-per-Second Anzeige
 */
function updateStatsDisplay() {
    pointsPerSecondDisplay.textContent = game.state.pointsPerSecond.toFixed(1);
    clickValueDisplay.textContent = game.state.clickPower;
}

/**
 * Aktualisiert alle Upgrade-Karten
 */
function updateUpgradesDisplay() {
    game.upgrades.forEach(upgrade => {
        const info = upgrade.getInfo();
        const levelEl = document.getElementById(`level-${upgrade.id}`);
        const costEl = document.getElementById(`cost-${upgrade.id}`);
        const nextCostEl = document.getElementById(`nextCost-${upgrade.id}`);
        const buttonEl = document.getElementById(`btn-${upgrade.id}`);
        const cardEl = document.getElementById(`upgrade-${upgrade.id}`);
        const unlockEl = document.getElementById(`unlock-${upgrade.id}`);
        const statsEl = document.getElementById(`stats-${upgrade.id}`);

        // Check if upgrade is locked
        if (!info.unlocked) {
            // Show locked state
            if (cardEl) {
                cardEl.classList.add('locked');
                cardEl.classList.remove('disabled');
            }
            if (unlockEl) {
                unlockEl.style.display = 'block';
                const unlockText = unlockEl.querySelector('.unlock-text');
                if (unlockText) {
                    unlockText.textContent = info.unlockDescription || 'Locked';
                }
            }
            if (statsEl) statsEl.style.display = 'none';
            if (buttonEl) {
                buttonEl.style.display = 'none';
            }
            return; // Skip weitere Updates f√ºr locked upgrades
        }

        // Upgrade is unlocked - show normal state
        if (cardEl) cardEl.classList.remove('locked');
        if (unlockEl) unlockEl.style.display = 'none';
        if (statsEl) statsEl.style.display = 'flex';
        if (buttonEl) buttonEl.style.display = 'block';

        // Update Werte
        if (levelEl) levelEl.textContent = info.level;
        if (costEl) costEl.textContent = formatNumber(info.currentCost);
        if (nextCostEl) {
            nextCostEl.textContent = info.nextCost ? formatNumber(info.nextCost) : 'MAX';
        }

        // Update Button State
        if (buttonEl) {
            const canAfford = upgrade.canAfford(game.state.points);
            buttonEl.disabled = !canAfford;

            if (info.level >= info.maxLevel) {
                buttonEl.textContent = 'MAX LEVEL';
                buttonEl.disabled = true;
            } else {
                buttonEl.textContent = 'BUY';
            }
        }

        // Update Card State
        if (cardEl) {
            if (upgrade.canAfford(game.state.points)) {
                cardEl.classList.remove('disabled');
            } else {
                cardEl.classList.add('disabled');
            }
        }
    });
}

/**
 * Zeigt eine Unlock-Benachrichtigung
 * @param {Upgrade} upgrade - Das freigeschaltete Upgrade
 */
function showUnlockNotification(upgrade) {
    const notification = document.createElement('div');
    notification.className = 'unlock-notification';
    notification.innerHTML = `
        <div class="unlock-notification-content">
            <span class="unlock-icon">üîì</span>
            <div class="unlock-message">
                <strong>Neues Upgrade freigeschaltet!</strong>
                <p>${upgrade.name}</p>
            </div>
        </div>
    `;

    document.body.appendChild(notification);

    // Animation: Slide in
    setTimeout(() => {
        notification.classList.add('show');
    }, 10);

    // Remove nach 3 Sekunden
    setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 3000);
}

/**
 * Aktualisiert das gesamte UI
 */
function updateUI() {
    updatePointsDisplay();
    updateStatsDisplay();
    updateUpgradesDisplay();
}

// ===== EVENT LISTENERS =====

// Click Button
clickButton.addEventListener('click', () => {
    game.click();
    updateUI();
});

// Upgrade Buttons
game.upgrades.forEach(upgrade => {
    const button = document.getElementById(`btn-${upgrade.id}`);
    if (button) {
        button.addEventListener('click', () => {
            if (game.buyUpgrade(upgrade.id)) {
                updateUI();
            }
        });
    }
});

// Game Events
game.on('pointsChanged', () => {
    updatePointsDisplay();
    updateUpgradesDisplay();
});

game.on('statsChanged', () => {
    updateStatsDisplay();
});

game.on('tick', () => {
    updateUI();
});

game.on('idleProgress', (data) => {
    console.log(`Offline-Fortschritt: ${data.offlineTime.toFixed(0)}s, ${data.pointsEarned.toFixed(0)} Punkte verdient`);
});

game.on('gameSaved', () => {
    // Optional: Visuelles Feedback f√ºr Auto-Save
    // console.log('Spiel gespeichert');
});

game.on('upgradeUnlocked', (upgrade) => {
    console.log(`Neues Upgrade freigeschaltet: ${upgrade.name}!`);
    // Show unlock notification
    showUnlockNotification(upgrade);
    updateUI();
});

// ===== INITIALISIERUNG =====

// Erstes UI Update
updateUI();

// UI Update Interval (zus√§tzlich zu den Events)
setInterval(updateUI, 100);

// ===== DEBUG FUNKTIONEN (Optional, k√∂nnen entfernt werden) =====

// Keyboard Shortcuts f√ºr Testing
document.addEventListener('keydown', (e) => {
    // 'R' f√ºr Reset (mit Best√§tigung)
    if (e.key === 'r' || e.key === 'R') {
        if (confirm('Spiel wirklich zur√ºcksetzen? Alle Fortschritte gehen verloren!')) {
            game.reset();
            updateUI();
        }
    }

    // 'S' f√ºr manuelles Speichern
    if (e.key === 's' || e.key === 'S') {
        game.saveGame();
        console.log('Spiel manuell gespeichert');
    }

    // '+' f√ºr 100 Bonus-Punkte (nur f√ºr Testing)
    if (e.key === '+') {
        game.addPoints(100);
        console.log('100 Bonus-Punkte hinzugef√ºgt');
    }
});

// Expose game object f√ºr Console-Debugging
window.game = game;

console.log('Idle Clicker Game geladen!');
console.log('Shortcuts: R = Reset, S = Save, + = 100 Bonus Points');
